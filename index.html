<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GeniusHub Reporter</title>
    
    <!-- PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4338ca">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' fill='%234338ca'/%3E%3Cpath d='M368 128h-64v-16c0-17.6-14.4-32-32-32h-32c-17.6 0-32 14.4-32 32v16h-64c-17.6 0-32 14.4-32 32v288c0 17.6 14.4 32 32 32h224c17.6 0 32-14.4 32-32V160c0-17.6-14.4-32-32-32zm-128 0h32v16h-32v-16zm112 272H160V176h48v24h96v-24h48v224z' fill='white'/%3E%3Cpath d='M200 248h112v32H200zm0 80h112v32H200z' fill='white' opacity='0.7'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' fill='%234338ca'/%3E%3Cpath d='M368 128h-64v-16c0-17.6-14.4-32-32-32h-32c-17.6 0-32 14.4-32 32v16h-64c-17.6 0-32 14.4-32 32v288c0 17.6 14.4 32 32 32h224c17.6 0 32-14.4 32-32V160c0-17.6-14.4-32-32-32zm-128 0h32v16h-32v-16zm112 272H160V176h48v24h96v-24h48v224z' fill='white'/%3E%3C/svg%3E">

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Status Badges */
        .badge-positive { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-negative { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-neutral { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

        /* HEADER PADDING */
        .safe-top { 
            padding-top: max(3.5rem, env(safe-area-inset-top) + 2.5rem); 
        }
        
        .safe-bottom { padding-bottom: max(1.5rem, env(safe-area-inset-bottom) + 1rem); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .card-shadow { box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05); }

        /* Animation */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        .modal-overlay {
            backdrop-filter: blur(4px);
            transition: opacity 0.2s ease-in-out;
            z-index: 100;
        }

        /* iOS Date Input Fix */
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            min-height: 2.5rem;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-700 px-6 pb-6 pt-14 safe-top text-white shadow-lg sticky top-0 z-50 rounded-b-[2rem]">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">GeniusHub</h1>
                <p class="text-[10px] text-indigo-200 uppercase font-bold tracking-widest">Reporter</p>
            </div>
            <div class="flex gap-2">
                <!-- Settings Button -->
                <button onclick="openSettings()" class="bg-indigo-800/50 p-2 rounded-xl active:scale-95 transition-transform hover:bg-indigo-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                <!-- Add Student Toggle -->
                <button onclick="toggleAddStudent()" class="bg-white text-indigo-700 p-2 rounded-xl active:scale-95 transition-transform font-bold shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-slate-900/60 modal-overlay hidden items-center justify-center p-4 z-[110]">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 space-y-4 animate-in fade-in zoom-in duration-200 text-center">
            <div class="mx-auto w-14 h-14 bg-red-100 rounded-full flex items-center justify-center mb-2 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            </div>
            <h3 id="confirm-title" class="text-xl font-black text-slate-800">Are you sure?</h3>
            <p id="confirm-msg" class="text-sm text-slate-500 font-medium leading-relaxed">This action cannot be undone.</p>
            <div class="flex gap-3 pt-4">
                <button onclick="closeConfirm()" class="flex-1 py-3.5 font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-2xl transition-colors active:scale-95">Cancel</button>
                <button id="confirm-btn-yes" class="flex-1 py-3.5 font-bold text-white bg-red-500 hover:bg-red-600 shadow-lg shadow-red-200 rounded-2xl transition-colors active:scale-95">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal (NEW) -->
    <div id="edit-student-modal" class="fixed inset-0 bg-slate-900/60 modal-overlay hidden items-center justify-center p-4 z-[110]">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 space-y-4 animate-in fade-in zoom-in duration-200">
            <div class="text-center">
                <h3 class="text-xl font-black text-slate-800">Edit Student</h3>
                <p class="text-xs text-slate-500 font-bold">Update details below</p>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Name</label>
                    <input type="text" id="edit-student-name" class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl outline-none focus:border-indigo-500 font-bold text-slate-800">
                </div>
                <div>
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Grade</label>
                    <input type="text" id="edit-student-grade" class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl outline-none focus:border-indigo-500 font-bold text-slate-800">
                </div>
                <input type="hidden" id="edit-student-original-name">
            </div>
            <div class="flex gap-2">
                <button onclick="closeEditModal()" class="flex-1 py-3 font-bold text-slate-400 bg-slate-50 rounded-xl hover:bg-slate-100">Cancel</button>
                <button onclick="saveEditStudent()" class="flex-1 py-3 font-bold text-white bg-indigo-600 rounded-xl shadow-lg shadow-indigo-100 hover:bg-indigo-700">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-overlay" class="fixed inset-0 bg-slate-900/60 modal-overlay hidden items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 space-y-4 animate-in fade-in zoom-in duration-200">
            <div class="flex justify-between items-center border-b pb-2">
                <h3 class="text-lg font-black text-slate-800">Data Management</h3>
                <button onclick="closeSettings()" class="text-slate-400 font-bold p-2 hover:bg-slate-50 rounded-full">‚úï</button>
            </div>
            
            <div class="space-y-3 pt-2">
                <div class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100 space-y-2">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-200 p-2 rounded-full text-indigo-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-indigo-900 text-sm">Backup Data</h4>
                            <p class="text-[10px] text-indigo-600">Save file to move to new phone</p>
                        </div>
                    </div>
                    <button onclick="exportData()" class="w-full py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-md shadow-indigo-200 active:scale-95 transition-transform">Download Backup</button>
                </div>

                <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100 space-y-2">
                    <div class="flex items-center gap-3">
                        <div class="bg-amber-200 p-2 rounded-full text-amber-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-amber-900 text-sm">Restore Data</h4>
                            <p class="text-[10px] text-amber-700">Load a backup file</p>
                        </div>
                    </div>
                    <button onclick="triggerImport()" class="w-full py-2 bg-amber-500 text-white rounded-xl text-xs font-bold shadow-md shadow-amber-200 active:scale-95 transition-transform">Upload File</button>
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                </div>

                <div class="pt-4 border-t">
                    <button onclick="clearData()" class="w-full py-3 text-red-500 font-bold text-xs uppercase tracking-widest hover:bg-red-50 rounded-xl transition-colors">
                        Delete All Data (Reset)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 safe-bottom overflow-y-auto custom-scrollbar">
        
        <!-- 1. STUDENTS LIST VIEW (Default) -->
        <div id="view-students" class="space-y-4 max-w-md mx-auto animate-slide-up">
            
            <!-- Add Student Form -->
            <div id="add-student-panel" class="hidden bg-white p-4 rounded-2xl border-2 border-indigo-100 shadow-lg mb-4 animate-slide-up">
                <h3 class="text-xs font-black uppercase text-indigo-600 mb-2">Add New Student</h3>
                <div class="space-y-2">
                    <input type="text" id="new-student-name" placeholder="Student Name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold">
                    <div class="flex gap-2">
                        <input type="text" id="new-student-grade" placeholder="Grade (e.g. 10th)" class="flex-grow p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold">
                        <button onclick="addStudent()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold shadow-md shadow-indigo-200 active:scale-95 transition-transform">Save</button>
                    </div>
                </div>
            </div>

            <!-- List -->
            <div id="students-list" class="grid grid-cols-1 gap-3">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- 2. LOG SESSION VIEW -->
        <div id="view-log" class="hidden space-y-4 max-w-md mx-auto animate-slide-up">
            <button onclick="switchTab('students')" class="text-sm font-bold text-slate-500 hover:text-indigo-600 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                Back to Students
            </button>
            
            <div class="bg-white p-6 rounded-[2rem] card-shadow border border-slate-100 space-y-5">
                <div class="flex justify-between items-center border-b border-slate-100 pb-2">
                    <h3 class="text-lg font-black text-slate-800">Log Session</h3>
                    <span id="display-log-name" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg">Student</span>
                    <input type="hidden" id="log-name">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Date</label>
                    <input type="date" id="log-date" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-medium text-slate-800">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Topic Taught</label>
                    <input type="text" id="log-topic" placeholder="e.g. Algebra II" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-medium text-slate-800">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Homework Status</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="setHomework('Done')" class="hw-btn p-3 rounded-xl border-2 border-slate-100 text-xs font-bold text-slate-500 hover:bg-green-50 hover:text-green-700 transition-all" data-val="Done">Done ‚úÖ</button>
                        <button type="button" onclick="setHomework('Partial')" class="hw-btn p-3 rounded-xl border-2 border-slate-100 text-xs font-bold text-slate-500 hover:bg-amber-50 hover:text-amber-700 transition-all" data-val="Partial">Partial ‚ö†Ô∏è</button>
                        <button type="button" onclick="setHomework('Not Done')" class="hw-btn p-3 rounded-xl border-2 border-slate-100 text-xs font-bold text-slate-500 hover:bg-red-50 hover:text-red-700 transition-all" data-val="Not Done">None ‚ùå</button>
                    </div>
                    <input type="hidden" id="log-hw">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Class Interaction</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" onclick="setActive('Fully Active')" class="act-btn p-3 rounded-xl border-2 border-slate-100 text-xs font-bold text-slate-500 hover:bg-indigo-50 hover:text-indigo-700 transition-all" data-val="Fully Active">Fully Active üåü</button>
                        <button type="button" onclick="setActive('Distracted')" class="act-btn p-3 rounded-xl border-2 border-slate-100 text-xs font-bold text-slate-500 hover:bg-slate-100 hover:text-slate-700 transition-all" data-val="Distracted">Distracted üí§</button>
                    </div>
                    <input type="hidden" id="log-active">
                </div>

                <button onclick="saveSession()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-xl hover:bg-indigo-700 active:scale-95 transition-all mt-4">Save Log</button>
            </div>
            <div class="text-center">
                <p id="save-msg" class="text-green-600 font-bold text-sm hidden">Saved Successfully! ‚ú®</p>
            </div>
        </div>

        <!-- 3. REPORT VIEW -->
        <div id="view-report" class="hidden space-y-4 max-w-md mx-auto animate-slide-up">
            <button onclick="switchTab('students')" class="text-sm font-bold text-slate-500 hover:text-indigo-600 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                Back to Students
            </button>
            
            <div class="bg-white p-5 rounded-[2rem] card-shadow border border-slate-100 space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest">Report Options</h3>
                    <span id="display-report-name" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg">Student</span>
                    <input type="hidden" id="report-student">
                </div>
                
                <div class="flex gap-2">
                    <div class="flex-1 min-w-0">
                        <label class="text-[9px] font-bold uppercase text-slate-400 ml-1">From</label>
                        <input type="date" id="report-start" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold appearance-none">
                    </div>
                    <div class="flex-1 min-w-0">
                        <label class="text-[9px] font-bold uppercase text-slate-400 ml-1">To</label>
                        <input type="date" id="report-end" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold appearance-none">
                    </div>
                </div>

                <div class="flex gap-2 pt-1">
                    <button onclick="setRange('week')" class="flex-1 py-2 bg-slate-100 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-200 active:scale-95 transition-transform">Last 7 Days</button>
                    <button onclick="setRange('month')" class="flex-1 py-2 bg-slate-100 text-slate-600 text-xs font-bold rounded-lg hover:bg-slate-200 active:scale-95 transition-transform">This Month</button>
                </div>

                <button onclick="generateReport()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 active:scale-95 transition-transform">Show Report</button>
            </div>

            <!-- Results -->
            <div id="report-results" class="hidden space-y-4 pb-10">
                <div class="flex flex-col gap-2 px-2">
                    <h3 class="text-sm font-bold text-slate-500" id="report-count">0 Sessions Found</h3>
                    <div class="flex gap-2">
                        <button onclick="copyReport()" class="flex-1 text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-3 rounded-xl border border-indigo-100 flex justify-center items-center gap-1 active:scale-95 transition-transform">
                            üìã Copy Text
                        </button>
                        <button onclick="shareOrDownloadPDF()" class="flex-1 text-xs font-bold text-white bg-red-500 px-3 py-3 rounded-xl shadow-md shadow-red-200 flex justify-center items-center gap-1 active:scale-95 transition-transform">
                            üìÑ Share / Download PDF
                        </button>
                    </div>
                </div>

                <div id="report-list" class="space-y-3"></div>
            </div>
        </div>

    </main>

    <script>
        const { jsPDF } = window.jspdf;

        // --- DATA & STATE ---
        let sessions = JSON.parse(localStorage.getItem('geniushub_sessions')) || [];
        let storedStudents = JSON.parse(localStorage.getItem('geniushub_students')) || [];
        let students = storedStudents.map(s => (typeof s === 'string') ? { name: s, grade: '' } : s);
        
        let confirmCallback = null;

        // --- INIT ---
        window.onload = () => {
            document.getElementById('log-date').valueAsDate = new Date();
            setRange('week');
            renderStudents();
            localStorage.setItem('geniushub_students', JSON.stringify(students));
        };

        // --- NAVIGATION & SETTINGS ---
        function switchTab(tab) {
            const views = ['view-students', 'view-log', 'view-report'];
            
            views.forEach(v => {
                const el = document.getElementById(v);
                if(v === `view-${tab}`) {
                    el.classList.remove('hidden');
                    el.classList.add('animate-slide-up');
                } else {
                    el.classList.add('hidden');
                    el.classList.remove('animate-slide-up');
                }
            });
        }

        function toggleAddStudent() {
            const panel = document.getElementById('add-student-panel');
            panel.classList.toggle('hidden');
            if(!panel.classList.contains('hidden')) {
                document.getElementById('new-student-name').focus();
            }
        }

        function openSettings() {
            document.getElementById('settings-overlay').classList.remove('hidden');
            document.getElementById('settings-overlay').classList.add('flex');
        }

        function closeSettings() {
            document.getElementById('settings-overlay').classList.add('hidden');
            document.getElementById('settings-overlay').classList.remove('flex');
        }

        // --- CUSTOM CONFIRM MODAL ---
        function showConfirm(title, msg, callback) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.add('flex');
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-modal').classList.remove('flex');
            confirmCallback = null;
        }

        document.getElementById('confirm-btn-yes').onclick = () => {
            if (confirmCallback) confirmCallback();
            closeConfirm();
        };

        // --- EDIT MODAL LOGIC ---
        function openEditModal(name, grade) {
            document.getElementById('edit-student-original-name').value = name;
            document.getElementById('edit-student-name').value = name;
            document.getElementById('edit-student-grade').value = grade || '';
            document.getElementById('edit-student-modal').classList.remove('hidden');
            document.getElementById('edit-student-modal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('edit-student-modal').classList.add('hidden');
            document.getElementById('edit-student-modal').classList.remove('flex');
        }

        function saveEditStudent() {
            const originalName = document.getElementById('edit-student-original-name').value;
            const newName = document.getElementById('edit-student-name').value.trim();
            const newGrade = document.getElementById('edit-student-grade').value.trim();

            if (!newName) return alert("Name cannot be empty");

            // Check duplicate if name changed
            if (newName !== originalName && students.some(s => s.name === newName)) {
                return alert("Student name already exists!");
            }

            // Update List
            const studentIndex = students.findIndex(s => s.name === originalName);
            if (studentIndex !== -1) {
                students[studentIndex].name = newName;
                students[studentIndex].grade = newGrade;
                students.sort((a, b) => a.name.localeCompare(b.name));
                localStorage.setItem('geniushub_students', JSON.stringify(students));
            }

            // Update Logs if name changed
            if (newName !== originalName) {
                let sessionsChanged = false;
                sessions.forEach(s => {
                    if (s.name === originalName) {
                        s.name = newName;
                        sessionsChanged = true;
                    }
                });
                if (sessionsChanged) {
                    localStorage.setItem('geniushub_sessions', JSON.stringify(sessions));
                }
            }

            renderStudents();
            closeEditModal();
        }

        // --- DATA MANAGEMENT ---
        function exportData() {
            const data = {
                students: JSON.parse(localStorage.getItem('geniushub_students') || '[]'),
                sessions: JSON.parse(localStorage.getItem('geniushub_sessions') || '[]')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GeniusHub_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function triggerImport() { document.getElementById('import-file').click(); }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.students && data.sessions) {
                        localStorage.setItem('geniushub_students', JSON.stringify(data.students));
                        localStorage.setItem('geniushub_sessions', JSON.stringify(data.sessions));
                        alert("Data restored successfully! App will reload.");
                        location.reload();
                    } else {
                        alert("Invalid backup file format.");
                    }
                } catch(err) { alert("Error reading file"); }
            };
            reader.readAsText(file);
        }

        function clearData() {
            showConfirm(
                "Reset App Data?",
                "This will permanently delete ALL students and logged sessions. This action cannot be undone.",
                () => {
                    localStorage.removeItem('geniushub_students');
                    localStorage.removeItem('geniushub_sessions');
                    location.reload();
                }
            );
        }

        // --- STUDENT MANAGEMENT ---
        function addStudent() {
            const nameInput = document.getElementById('new-student-name');
            const gradeInput = document.getElementById('new-student-grade');
            const name = nameInput.value.trim();
            const grade = gradeInput.value.trim();

            if(name && !students.some(s => s.name === name)) {
                students.push({ name, grade });
                students.sort((a, b) => a.name.localeCompare(b.name));
                localStorage.setItem('geniushub_students', JSON.stringify(students));
                
                nameInput.value = '';
                gradeInput.value = '';
                toggleAddStudent();
                renderStudents();
            }
        }

        function deleteStudent(name) {
            showConfirm(
                "Delete Student?",
                `Are you sure you want to remove ${name}? This will remove them from your list.`,
                () => {
                    students = students.filter(s => s.name !== name);
                    localStorage.setItem('geniushub_students', JSON.stringify(students));
                    renderStudents();
                }
            );
        }

        function renderStudents() {
            const list = document.getElementById('students-list');
            if(students.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-slate-400"><p class="text-sm">No students yet.</p><p class="text-xs mt-1">Tap + to add one.</p></div>`;
                return;
            }

            list.innerHTML = students.map(s => `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
                    <div class="flex-grow">
                        <div class="flex items-center gap-2">
                            <h4 class="font-bold text-slate-800 text-lg">${s.name}</h4>
                            <button onclick="openEditModal('${s.name}', '${s.grade}')" class="text-slate-300 hover:text-indigo-500 transition-colors p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button onclick="deleteStudent('${s.name}')" class="text-slate-300 hover:text-red-500 transition-colors p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${s.grade || 'Student'}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="quickAction('${s.name}', 'log')" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold active:scale-95 transition-transform border border-indigo-100">Log</button>
                        <button onclick="quickAction('${s.name}', 'report')" class="px-4 py-2 bg-slate-50 text-slate-500 rounded-xl text-xs font-bold active:scale-95 transition-transform border border-slate-200">Report</button>
                    </div>
                </div>
            `).join('');
        }

        function quickAction(name, action) {
            if(action === 'log') {
                document.getElementById('log-name').value = name;
                document.getElementById('display-log-name').innerText = name;
                switchTab('log');
            } else {
                document.getElementById('report-student').value = name;
                document.getElementById('display-report-name').innerText = name;
                switchTab('report');
                generateReport();
            }
        }

        // --- LOGGING ---
        function setHomework(status) {
            document.getElementById('log-hw').value = status;
            document.querySelectorAll('.hw-btn').forEach(btn => {
                if (btn.dataset.val === status) {
                    btn.classList.add('ring-2', 'ring-offset-1', 'ring-indigo-500', 'bg-slate-50');
                    if(status === 'Done') btn.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
                    if(status === 'Partial') btn.classList.add('bg-amber-50', 'text-amber-700', 'border-amber-200');
                    if(status === 'Not Done') btn.classList.add('bg-red-50', 'text-red-700', 'border-red-200');
                } else {
                    btn.classList.remove('ring-2', 'ring-offset-1', 'ring-indigo-500', 'bg-green-50', 'bg-amber-50', 'bg-red-50', 'text-green-700', 'text-amber-700', 'text-red-700', 'border-green-200', 'border-amber-200', 'border-red-200');
                }
            });
        }

        function setActive(status) {
            document.getElementById('log-active').value = status;
            document.querySelectorAll('.act-btn').forEach(btn => {
                if (btn.dataset.val === status) {
                    btn.classList.add('ring-2', 'ring-offset-1', 'ring-indigo-500');
                    if(status === 'Fully Active') btn.classList.add('bg-indigo-50', 'text-indigo-700', 'border-indigo-200');
                    else btn.classList.add('bg-slate-100', 'text-slate-700', 'border-slate-300');
                } else {
                    btn.classList.remove('ring-2', 'ring-offset-1', 'ring-indigo-500', 'bg-indigo-50', 'text-indigo-700', 'border-indigo-200', 'bg-slate-100', 'text-slate-700', 'border-slate-300');
                }
            });
        }

        function saveSession() {
            const name = document.getElementById('log-name').value.trim();
            const date = document.getElementById('log-date').value;
            const topic = document.getElementById('log-topic').value.trim();
            const hw = document.getElementById('log-hw').value;
            const active = document.getElementById('log-active').value;

            if (!name || !date || !topic || !hw || !active) {
                alert("Please fill all fields!");
                return;
            }

            const session = { id: Date.now(), name, date, topic, hw, active };
            sessions.push(session);
            sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem('geniushub_sessions', JSON.stringify(sessions));

            document.getElementById('log-topic').value = '';
            document.getElementById('log-hw').value = '';
            document.getElementById('log-active').value = '';
            document.querySelectorAll('.hw-btn, .act-btn').forEach(btn => btn.className = btn.className.replace(/ring-2|bg-green-50|bg-amber-50|bg-red-50|bg-indigo-50/g, '').trim());

            const msg = document.getElementById('save-msg');
            msg.classList.remove('hidden');
            setTimeout(() => {
                msg.classList.add('hidden');
                switchTab('students');
            }, 1500);
        }

        // --- REPORTING ---
        function setRange(type) {
            const end = new Date();
            const start = new Date();
            if (type === 'week') start.setDate(end.getDate() - 7);
            else if (type === 'month') start.setDate(1);
            
            // Format for HTML date input (YYYY-MM-DD)
            document.getElementById('report-end').value = end.toISOString().split('T')[0];
            document.getElementById('report-start').value = start.toISOString().split('T')[0];
        }

        function getFilteredData() {
            const studentName = document.getElementById('report-student').value;
            const startDate = new Date(document.getElementById('report-start').value);
            const endDate = new Date(document.getElementById('report-end').value);
            endDate.setHours(23, 59, 59);

            return sessions.filter(s => {
                const sDate = new Date(s.date);
                return sDate >= startDate && sDate <= endDate && s.name === studentName;
            });
        }

        function generateReport() {
            const data = getFilteredData();
            const container = document.getElementById('report-list');
            document.getElementById('report-results').classList.remove('hidden');
            document.getElementById('report-count').innerText = `${data.length} Sessions Found`;
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `<div class="text-center p-8 text-slate-400 text-xs font-bold uppercase tracking-widest">No matching records</div>`;
                return;
            }

            data.forEach(s => {
                let hwClass = 'badge-neutral';
                if(s.hw === 'Done') hwClass = 'badge-positive';
                if(s.hw === 'Not Done') hwClass = 'badge-negative';
                if(s.hw === 'Partial') hwClass = 'bg-amber-50 text-amber-700 border border-amber-200';

                container.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col gap-2">
                        <div class="flex justify-between items-start">
                            <div><span class="text-xs text-slate-400 font-mono font-bold">${s.date}</span></div>
                            <span class="text-[10px] font-bold uppercase px-2 py-1 rounded-md ${hwClass}">HW: ${s.hw}</span>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl"><p class="text-xs text-slate-500 font-bold uppercase mb-1">Topic</p><p class="text-sm font-medium text-slate-800">${s.topic}</p></div>
                        <div class="flex items-center gap-2 text-xs"><span class="text-slate-400 font-bold">Interaction:</span><span class="font-bold ${s.active === 'Fully Active' ? 'text-indigo-600' : 'text-slate-500'}">${s.active}</span></div>
                    </div>`;
            });
        }

        function copyReport() {
            const data = getFilteredData();
            if(data.length === 0) return alert("No data!");
            const studentName = document.getElementById('report-student').value;
            
            // Updated text copy header
            let report = `*Daily Sessions Report: ${studentName}*\nüìÖ ${document.getElementById('report-start').value} to ${document.getElementById('report-end').value}\n\n`;
            data.forEach(s => {
                let icon = s.hw === 'Done' ? '‚úÖ' : (s.hw === 'Partial' ? '‚ö†Ô∏è' : '‚ùå');
                report += `üìå *${s.date}*\nüìñ Topic: ${s.topic}\nüìù HW: ${s.hw} ${icon}\n‚ö° Activity: ${s.active}\n------------------\n`;
            });
            report += `\nThanks,\nAmar Bhushan`;
            
            navigator.clipboard.writeText(report).then(() => alert("Copied for WhatsApp!"));
        }

        async function shareOrDownloadPDF() {
            const data = getFilteredData();
            if(data.length === 0) return alert("No data to generate PDF!");
            const studentName = document.getElementById('report-student').value;
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;
            
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.setTextColor(67, 56, 202);
            doc.text("GeniusHub Daily Sessions Report", 14, 22);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            const student = students.find(s => s.name === studentName);
            const gradeText = student && student.grade ? `(${student.grade})` : "";
            doc.text(`Student: ${studentName} ${gradeText}`, 14, 30);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 35);
            doc.line(14, 38, 196, 38);

            const tableData = data.map(s => [s.date, s.topic, s.hw, s.active]);
            doc.autoTable({
                startY: 45,
                head: [['Date', 'Topic', 'Homework', 'Interaction']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [67, 56, 202] },
                styles: { fontSize: 10, cellPadding: 3 }
            });

            const finalY = doc.lastAutoTable.finalY || 50;
            doc.setFontSize(10);
            doc.setTextColor(150);
            doc.text("Generated by GeniusHub - Amar Bhushan", 14, finalY + 10);

            const fileName = `${studentName} Everyday Class Report ${startDate} to ${endDate}.pdf`;

            // Try Web Share API first
            const pdfBlob = doc.output('blob');
            const file = new File([pdfBlob], fileName, { type: "application/pdf" });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'GeniusHub Report',
                        text: `Here is the report for ${studentName}.`
                    });
                } catch (error) {
                    console.log('Share failed or cancelled', error);
                }
            } else {
                // Fallback to direct download
                doc.save(fileName);
            }
        }
    </script>
</body>
</html>
